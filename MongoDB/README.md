# 使用 Mongoose 连接 MongoDB 数据库

**本章提要**

* 安装和使用 Mongoose

* 定义模式和模型

* 理解 Mongoose 的数据类型

* 使用模式验证

* 查找、插入和更新文档

* 给查询结果标记分页

* 定义索引

* 应用取值器、赋值器和虚属性

* 引用记录

* 用高级方法丰富模型和文档对象

面向文档的数据库在最近几年重获流行，并处于 NoSQL 运动的前锋和中心。这种类型的数据库与关系型数据库不同，它不需要事先指定数据结构，相反你可以根据项目需要有组织地改变数据结构。与关系数据库的另一个重要的不同之处在于文档是原子单元，可以根据需要保证其完整性，因此不再需要跨表联合和事务。

[MongoDB](http://www.mongodb.org.cn/) 是一个很流行的面向文档的数据库，可以让你使用强大的查询语言执行动态查询。

在 MongoDB 中，数据被组织起来以便 MongoDB 能保持一组集合，每个集合中都有一组文档，每个文档又有一组字段。字段是一个键-值对，其中键是字符串，而值是一种基本类型（比如字符串、整数、 浮点数、时间戳、 二进制等等），或者是嵌入式文档，或者是任何数据类型的集合。

MongoDB 查询可以用 Javascript 文档描述，比如说有一个用户集合，想在其中查找所有名为 “John”、姓为 “Doe” 的用户，就可以使用如下查询语句：

```js
{name: {first: 'John', last: 'Doe'}}
```

还可以使用如下所示的查询语句查找所有姓为 “Doe” 的用户：

```js
{'name.last': 'Doe'}
```

还可以用正则表达式来替代静态值。例如，要查找所有姓以 “D” 开头的用户，可以使用：

```js
{'name.last': /^D/}
```

 这对数组值也同样有效，例如，如果在一个文章集合中查找那些关键词为 node.js 的文章，可以使用如下所示的查询语句：

 ```js
 {keywords: 'node.js'}
 ```

 还可以通过使用如下所示的查询语句，匹配至少有一个关键词与关键词集合相符的有关文章：

 ```js
 {keywords: {'in': ['node.js', 'javascript']}}
 ```

 有若干与此类似的操作符，可以在查询中使用这些操作符，以便查找所有字段 count 的值大于 10 并小于等于 100 的所有文档：

 ```js
 {count: {'$gt': 10, '&lte': 100}}
```

> **[info] 注意**
>
> 注意：本书并不打算让你精通安装和查询MongoDB, 这是其他图书的目标。
>
>如果还没有在系统中安装 MongoDB 并且希望安装它，请访问 [MongoDB 官网](https://www.mongodb.com/)。
>
> 另一个选择是利用 MongoDB 的外部服务，比如https://www.compose.com/  上

## 安装 Mongoose

在本章中，将创建访问 MongoDB 服务器的代码，为此，在 Node 中将会用到第三方模块 MongoDB, [Mongoose](https://github.com/Automattic/mongoose) 允许采用对象模型来访问 MongoDB。

在第21章“使用 Express.js 创建 Web 应用程序”中，用到了几个路由监听器来管理用户，这些路由监听器就是管理用户数据库的公共接口。这个数据库是一个伪内存对象，显然无法使其持久化，仅能使其适用于原型。但是，既然可以通过 Mongoose 来使用 MongoDB 数据库，就可以用一个真正的持久化数据访问层来代替伪内存对象。

让我们从将第21章中的应用程序代码复制到新的项目目录中开始，进入项目目录，使用 npm 安装 mongoose:

```bash
$ npm install mongoose --save
```

## 理解 Mongoose 如何使用模型封装对数据库的访问

Mongoose 是一个对数据库交互对象建模的尸一个数据库有多个集合，每个娱今